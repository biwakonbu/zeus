# ゴールデンファイル管理ガイド

このディレクトリには E2E テストで使用するゴールデンファイル（期待される出力）を格納します。

## ファイル構成

```
golden/
├── README.md                         # このファイル
├── cli-init.golden.json              # zeus init 出力
├── cli-graph.golden.json             # zeus graph 出力
├── graph-state.golden.json           # Web グラフ状態
├── integration-graph-state.golden.json  # 統合テスト グラフ状態
└── snapshots/                        # 参照スクリーンショット
    ├── dashboard-loaded.png
    └── integration-final.png
```

## ゴールデンファイル形式

### JSON ゴールデンファイル

```json
{
  "metadata": {
    "test_id": "テストの識別子",
    "generated_at": "2026-01-17T04:00:00Z",
    "zeus_version": "0.1.0",
    "hash": "sha256:..."
  },
  "state": {
    // 期待される状態
  },
  "tolerance": {
    // 許容誤差
  }
}
```

### フィールド説明

| フィールド | 説明 |
|-----------|------|
| `metadata.test_id` | テストケースの一意な識別子 |
| `metadata.generated_at` | ゴールデンファイル生成日時（ISO 8601） |
| `metadata.zeus_version` | 生成時の Zeus バージョン |
| `metadata.hash` | 状態のハッシュ値（差分検知用） |
| `state` | 期待される状態オブジェクト |
| `tolerance` | 比較時の許容誤差設定 |

## 許容誤差（Tolerance）

環境依存性を排除するため、一部のフィールドは許容誤差を設定します。

| フィールド | デフォルト | 説明 |
|-----------|------------|------|
| `position` | 5 | 座標の許容誤差（ピクセル） |
| `zoom` | 0.01 | ズームレベルの許容誤差 |

### 例

```json
{
  "tolerance": {
    "position": 10,
    "zoom": 0.05
  }
}
```

座標 `(100, 200)` と `(105, 195)` は position=10 の場合、一致とみなされます。

## ゴールデンファイルの更新

### 1. 自動更新

```bash
/zeus-e2e-tester --update-golden
```

このオプションを付けると、テスト実行時に現在の出力でゴールデンファイルを上書きします。

### 2. 手動更新

1. テストを実行
2. 差分を確認
3. 必要に応じて JSON ファイルを編集
4. Git にコミット

## 比較ロジック

### 1. 構造比較

JSON の構造が一致するかを再帰的にチェック。

### 2. 値比較

- **文字列**: 完全一致
- **数値**: tolerance を考慮した近似比較
- **配列**: 順序も含めて比較
- **UUID**: 形式のみ検証（値は無視）

### 3. 除外フィールド

以下のフィールドは比較から除外されます：

- `generated_at`: タイムスタンプ
- `hash`: 計算値
- `id`: UUID（形式のみ検証）

## スナップショット（snapshots/）

### 用途

スナップショットは**参照用**であり、厳密なピクセル比較には使用しません。

- 致命的な描画エラーの検知
- 目視での確認
- ドキュメント用途

### 更新タイミング

- UI の大幅な変更時
- 新機能追加時
- `--update-golden` オプション実行時

### 注意事項

- OS/ブラウザによってレンダリングが異なる場合があります
- 差分が許容範囲かは人間が判断します
- CI では視覚的比較は行わず、状態検証のみ実行

## ベストプラクティス

### 1. 最小限の状態

```json
// 良い例：必要な情報のみ
{
  "state": {
    "nodeCount": 3,
    "edgeCount": 2
  }
}

// 悪い例：過剰な情報
{
  "state": {
    "nodes": [
      { "id": "...", "name": "...", "x": 100, "y": 200, ... },
      ...
    ]
  }
}
```

### 2. 環境依存性の排除

```json
// 良い例：相対的な検証
{
  "tolerance": { "position": 10 }
}

// 悪い例：固定座標
{
  "state": {
    "x": 540,
    "y": 320
  }
}
```

### 3. バージョン管理

ゴールデンファイルは Git で管理し、変更履歴を追跡します。

```bash
git diff golden/graph-state.golden.json
```

## トラブルシューティング

### テストが失敗する

1. 差分を確認
2. 意図した変更か判断
3. 意図した変更なら `--update-golden` で更新
4. 意図しない変更ならコードを修正

### スナップショットが異なる

1. OS/ブラウザの違いを確認
2. フォントレンダリングの差異を許容
3. 重大な差異のみ調査

### ハッシュ値が一致しない

1. `tolerance` を調整
2. 除外フィールドを追加
3. 状態の正規化を検討
